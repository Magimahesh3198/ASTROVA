from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters
)
import asyncio
import nest_asyncio
import math
import time  # for potential timeout or debug purposes
from AxTask import run_robot_task_to
from AxRobot import RobotManager
from config import config
import requests

TELEGRAM_TOKEN = "8143266327:AAGSoF0-9DeBtCybVaIhGpLsQH6JyjVxmmg"
PRIORITY_PASSWORD = "robotmaster123"
ROBOT_ID = "89824116043628m"

task_queue = []
current_task = None
running = False
queue_lock = asyncio.Lock()
robot_manager = RobotManager(config["token"])
password_waiting = {}  # chat_id: (poi, user_name)

# === Location-based Notification Constants ===
ALMOST_THERE_DISTANCE = 5.0  # meters
ARRIVAL_TOLERANCE = 0.5      # meters

# === Notification State ===
notification_sent = {
    'departed': False,
    'almost_there': False,
    'arrived': False
}

def reset_notification_flags():
    global notification_sent
    notification_sent = {
        'departed': False,
        'almost_there': False,
        'arrived': False
    }

# === Full POI List ===

POI_LIST = [
  {"name": "4D_Robot",            "coordinate": [  4.734035126432445,   -0.33602792868236975], "yaw": 179,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "AMR",                 "coordinate": [ 13.071532590060997,     5.23239284916599], "yaw":  92,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Board room",          "coordinate": [ 19.126824654165375,  -23.160599592984   ], "yaw":  90,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "CBS",                 "coordinate": [ 43.105000000000004,   33.84            ], "yaw":  84,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Cafeteria",           "coordinate": [ -0.605,              -25.485           ], "yaw": 118,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Car Parking(General)", "coordinate": [ 83.53073612369144,    0.0728256561899343], "yaw": 180,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Charging Station",    "coordinate": [  0.028294880667081166,   0.39899799464162183], "yaw": 266,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Charging startion 2", "coordinate": [ 56.8003459398907,   -26.283367735026687], "yaw": 358,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Entrance",            "coordinate": [ 73.12213900291908,   -21.365519944396283], "yaw": 179,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Finance",             "coordinate": [ 24.6425,             -23.527500000000003], "yaw":  91,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Founder Lounge",      "coordinate": [ 33.3525,             -23.015           ], "yaw":  92,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Founders Parking",    "coordinate": [ 82.07673440807639,   -31.450637353032107], "yaw":  92,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "HR Cabin",            "coordinate": [ 53.17259864582943,   -23.01558585419571 ], "yaw":  87,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Ideation",            "coordinate": [  8.2425,             -31.067500000000003], "yaw": 85.37,  "areaId": "67f77a224666c3f79fda5459"},
  {"name": "MB_ROBOT",            "coordinate": [ 32.1,                -6.892500000000001], "yaw":  89,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Main gate",           "coordinate": [107.65222863852841,  -11.346648091858924], "yaw": 192.83, "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Mat Bank",            "coordinate": [ -4.875,               38.56            ], "yaw": 273,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "NPD",                 "coordinate": [  8.47,              -22.525000000000002], "yaw":  91,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Pannel area",         "coordinate": [ 25.53,               31.66            ], "yaw": 185,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Play area",           "coordinate": [  3.76,              -18.44           ], "yaw":  89,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Project",             "coordinate": [ 47.03094220957382,  -22.410705935982378], "yaw":  90,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Reception",           "coordinate": [ 62.205043738356906, -22.5966745423629  ], "yaw": 91.18,  "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Rolling conveyor",    "coordinate": [ 39.61,               -2.0375          ], "yaw":   5,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Shutter",             "coordinate": [ 64.09747092618545,    1.935674457058667], "yaw": 180,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Testing area",        "coordinate": [ 40.44579003561921,    5.71749286962131 ], "yaw":  90,    "areaId": "67f77a224666c3f79fda5459"},
  {"name": "Training hall",       "coordinate": [ 12.255743409355091, -22.738723420161477], "yaw": 90.98,  "areaId": "67f77a224666c3f79fda5459"},
  {"name": "VR",                  "coordinate": [ 41.7875,             -22.5275         ], "yaw":  89,    "areaId": "67f77a224666c3f79fda5459"},
]


POI_MAP = {
    poi["name"].lower().replace(" ", "_"): poi for poi in POI_LIST
}

def robot_is_busy():
    success, data = robot_manager.getRobotState(ROBOT_ID)
    if success:
        print("[Robot Status]", data)
        is_moving = data.get("speed", 0) > 0.01
        has_error = data.get("isEmergencyStop") or bool(data.get("errors"))
        return is_moving or has_error
    print("[Robot Status] Failed to retrieve status.")
    return False

def robot_reached_destination(target_poi, tolerance=0.5):
    success, data = robot_manager.getRobotState(ROBOT_ID)
    if success:
        robot_x = data.get("x")
        robot_y = data.get("y")
        if robot_x is None or robot_y is None:
            return False

        target_x, target_y = target_poi["coordinate"]
        distance = math.hypot(robot_x - target_x, robot_y - target_y)
        print(f"[Robot Check] Distance to target: {distance:.2f}")
        return distance <= tolerance
    return False

async def check_location_and_notify(poi, chat_id):
    global notification_sent
    success, data = robot_manager.getRobotState(ROBOT_ID)
    if not success:
        print("[Notify] Failed to get robot state.")
        return

    robot_x = data.get("x")
    robot_y = data.get("y")
    target_x, target_y = poi["coordinate"]
    distance = math.hypot(robot_x - target_x, robot_y - target_y)
    current_speed = data.get("speed", 0)
    print(f"[Notify] Distance: {distance:.2f} m, Speed: {current_speed:.2f}")

    # Check if robot has departed
    if current_speed > 0.1 and not notification_sent['departed']:
        try:
            await app.bot.send_message(
                chat_id=chat_id,
                text="🚀 Out for delivery! Robot has departed."
            )
            print("[Notify] 'departed' message sent.")
        except Exception as e:
            print("[Error] Failed to send 'departed' message:", e)
        notification_sent['departed'] = True
        notification_sent['almost_there'] = False
        notification_sent['arrived'] = False

    # Check if robot is approaching destination
    if distance <= ALMOST_THERE_DISTANCE and not notification_sent['almost_there'] and notification_sent['departed']:
        try:
            await app.bot.send_message(
                chat_id=chat_id,
                text="🛵 Almost there! Robot is within 5 meters of destination."
            )
            print("[Notify] 'almost there' message sent.")
        except Exception as e:
            print("[Error] Failed to send 'almost there' message:", e)
        notification_sent['almost_there'] = True

    # Check if robot has arrived
    if distance <= ARRIVAL_TOLERANCE and current_speed < 0.1 and not notification_sent['arrived']:
        try:
            await app.bot.send_message(
                chat_id=chat_id,
                text=f"📍 Arrived at {poi['name']}! Robot is at location."
            )
            print("[Notify] 'arrived' message sent.")
        except Exception as e:
            print("[Error] Failed to send 'arrived' message:", e)
        notification_sent['arrived'] = True
        reset_notification_flags()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        await update.message.reply_text("Hi! 👋 Use /menu to choose a destination for the robot.")
    except Exception as e:
        print("[Error] In start:", e)

async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton(poi["name"], callback_data=key)]
        for key, poi in POI_MAP.items()
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    try:
        await update.message.reply_text("📍 Choose a destination:", reply_markup=reply_markup)
    except Exception as e:
        print("[Error] In show_menu:", e)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = query.from_user
    selected_key = query.data
    poi = POI_MAP[selected_key]

    async with queue_lock:
        if running:
            password_waiting[query.message.chat_id] = (poi, user.full_name)
            try:
                await query.message.reply_text("🔒 Robot is busy. Send priority password as your next message to override the queue.")
            except Exception as e:
                print("[Error] In button_handler (robot busy):", e)
            return

        task = {"user": user.full_name, "poi": poi, "chat_id": query.message.chat_id}
        task_queue.append(task)
        position = len(task_queue)
        try:
            await query.edit_message_text(text=f"📦 Task added to queue at position #{position}. Waiting for execution...")
        except Exception as e:
            print("[Error] In button_handler (edit_message):", e)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.message.chat_id
    text = update.message.text.strip()

    if chat_id in password_waiting:
        poi, user_name = password_waiting.pop(chat_id)
        if text == PRIORITY_PASSWORD:
            task = {"user": user_name, "poi": poi, "chat_id": chat_id}
            async with queue_lock:
                task_queue.insert(0, task)
            try:
                await update.message.reply_text("✅ Priority override accepted. Task moved to front of queue.")
            except Exception as e:
                print("[Error] In handle_message (priority override):", e)
        else:
            try:
                await update.message.reply_text("❌ Incorrect password. Task will remain in regular queue.")
            except Exception as e:
                print("[Error] In handle_message (incorrect password):", e)
            async with queue_lock:
                task_queue.append({"user": user_name, "poi": poi, "chat_id": chat_id})
    else:
        try:
            await update.message.reply_text("💡 Use /menu to select a destination from buttons.")
        except Exception as e:
            print("[Error] In handle_message (default):", e)

async def emergency_stop(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global running, current_task

    # Check if robot is actually moving
    if not robot_is_busy() and not running:
        try:
            await update.message.reply_text("🤖 Robot is not currently moving.")
        except Exception as e:
            print("[Error] In emergency_stop (not moving):", e)
        return

    # Send emergency stop command with retries
    max_retries = 3
    for attempt in range(max_retries):
        success, response = robot_manager.emergencyStop(ROBOT_ID)

        if success:
            await asyncio.sleep(1)  # Give robot time to react
            if robot_is_busy():
                try:
                    await update.message.reply_text("⚠️ Stop command sent but robot still moving. Retrying...")
                except Exception as e:
                    print("[Error] In emergency_stop (retry message):", e)
                continue

            async with queue_lock:
                running = False
                if current_task:
                    try:
                        await context.bot.send_message(
                            chat_id=current_task["chat_id"],
                            text=f"🛑 EMERGENCY STOP: Task to {current_task['poi']['name']} was interrupted!"
                        )
                    except Exception as e:
                        print("[Error] In emergency_stop (current_task message):", e)
                    current_task = None

                for task in task_queue:
                    try:
                        await context.bot.send_message(
                            chat_id=task["chat_id"],
                            text=f"🚨 Queued task to {task['poi']['name']} was cancelled due to emergency stop."
                        )
                    except Exception as e:
                        print("[Error] In emergency_stop (task queue message):", e)
                task_queue.clear()

                for chat_id in list(password_waiting.keys()):
                    password_waiting.pop(chat_id)

            success, status = robot_manager.getRobotState(ROBOT_ID)
            status_msg = (f"✅ Emergency stop successful!\n"
                          f"📍 Current position: x={status.get('x', '?')}, y={status.get('y', '?')}\n"
                          f"⚡ Battery: {status.get('battery', '?')}%\n"
                          f"🚦 Status: {'STOPPED' if not status.get('isEmergencyStop', True) else 'EMERGENCY_STOP'}")
            try:
                await update.message.reply_text(status_msg)
            except Exception as e:
                print("[Error] In emergency_stop (final status message):", e)
            return

    try:
        await update.message.reply_text("❌ EMERGENCY STOP FAILED after 3 attempts! Please check robot physically.")
    except Exception as e:
        print("[Error] In emergency_stop (failure message):", e)

async def task_worker():
    global running, current_task
    while True:
        await asyncio.sleep(1)
        print("[Worker] Tick | Running:", running, "| Queue:", len(task_queue), "| Busy:", robot_is_busy())

        if not running and task_queue and not robot_is_busy():
            async with queue_lock:
                current_task = task_queue.pop(0)
                running = True
                reset_notification_flags()

            chat_id = current_task["chat_id"]
            user = current_task["user"]
            poi = current_task["poi"]

            print(f"🔧 Running task for {user}: {poi['name']}")
            success, result = run_robot_task_to(poi)

            if not success:
                try:
                    await app.bot.send_message(chat_id=chat_id, text=f"❌ Task to {poi['name']} failed: {result}")
                except Exception as e:
                    print("[Error] In task_worker (task failure message):", e)
                running = False
                current_task = None
                continue

            while not robot_reached_destination(poi):
                await check_location_and_notify(poi, chat_id)
                await asyncio.sleep(2)
                print(f"⏳ Waiting for robot to reach {poi['name']}...")

            await check_location_and_notify(poi, chat_id)
            await asyncio.sleep(10)
            try:
                await app.bot.send_message(chat_id=chat_id, text=f"✅ Task to {poi['name']} completed!")
            except Exception as e:
                print("[Error] In task_worker (completion message):", e)
            running = False
            current_task = None

async def run_bot():
    global app
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("menu", show_menu))
    app.add_handler(CommandHandler("stop", emergency_stop))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    asyncio.create_task(task_worker())

    print("🤖 Telegram bot is running...")
    await app.run_polling()

if __name__ == "__main__":
    nest_asyncio.apply()
    asyncio.run(run_bot())
